name: Dependency Update Check

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  check-kotlin-updates:
    name: Check Kotlin Updates
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Check Kotlin version
        id: kotlin-version
        run: |
          CURRENT_VERSION=$(grep "^kotlin = " gradle/libs.versions.toml | cut -d '"' -f 2)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current Kotlin version: $CURRENT_VERSION"
      
      - name: Check latest Kotlin release
        id: kotlin-latest
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/JetBrains/kotlin/releases/latest | jq -r .tag_name | sed 's/v//')
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest Kotlin version: $LATEST_VERSION"
      
      - name: Compare Kotlin versions
        run: |
          CURRENT="${{ steps.kotlin-version.outputs.current_version }}"
          LATEST="${{ steps.kotlin-latest.outputs.latest_version }}"
          if [ "$CURRENT" != "$LATEST" ]; then
            echo "⚠️ Kotlin update available: $CURRENT -> $LATEST"
            echo "KOTLIN_UPDATE_AVAILABLE=true" >> $GITHUB_ENV
          else
            echo "✅ Kotlin is up to date: $CURRENT"
            echo "KOTLIN_UPDATE_AVAILABLE=false" >> $GITHUB_ENV
          fi

  check-google-services-updates:
    name: Check Google Services Updates
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Check Google Maps version
        id: maps-version
        run: |
          CURRENT_VERSION=$(grep "^google-maps = " gradle/libs.versions.toml | cut -d '"' -f 2)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current Google Maps version: $CURRENT_VERSION"
      
      - name: Check for Google Services updates
        run: |
          echo "📦 Checking Google Play Services updates..."
          echo "Current Google Maps: ${{ steps.maps-version.outputs.current_version }}"
          echo "Please check https://developers.google.com/android/guides/releases for latest versions"
          echo "Note: Automated version checking for Google Services requires Maven API queries"

  check-material-updates:
    name: Check Material Components Updates
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Check Compose BOM version
        id: compose-version
        run: |
          CURRENT_VERSION=$(grep "^compose-bom = " gradle/libs.versions.toml | cut -d '"' -f 2)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current Compose BOM version: $CURRENT_VERSION"
      
      - name: Check Material Icons version
        id: icons-version
        run: |
          CURRENT_VERSION=$(grep "^material-icons-extended = " gradle/libs.versions.toml | cut -d '"' -f 2)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current Material Icons Extended version: $CURRENT_VERSION"
      
      - name: Check for Material updates
        run: |
          echo "📦 Checking Material Components updates..."
          echo "Current Compose BOM: ${{ steps.compose-version.outputs.current_version }}"
          echo "Current Material Icons: ${{ steps.icons-version.outputs.current_version }}"
          echo "Please check https://developer.android.com/jetpack/compose/bom for latest BOM versions"

  gradle-dependency-updates:
    name: Gradle Dependency Updates Report
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Setup local.properties
        run: |
          echo "MAPS_API_KEY=dummy_key_for_ci" > local.properties
      
      - name: Check for dependency updates
        run: |
          # Note: This requires the Gradle Versions Plugin to be added to build.gradle.kts
          # Add the following to your build.gradle.kts to enable this:
          # plugins {
          #   id("com.github.ben-manes.versions") version "0.51.0"
          # }
          echo "Gradle Versions Plugin not yet configured."
          echo "To enable dependency update reports, add the plugin to build.gradle.kts"
          echo "See: https://github.com/ben-manes/gradle-versions-plugin"
        continue-on-error: true
      
      - name: Upload Dependency Updates Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-updates-report
          path: build/dependencyUpdates/
        continue-on-error: true

  create-update-summary:
    name: Create Update Summary
    runs-on: ubuntu-latest
    needs: [check-kotlin-updates, check-google-services-updates, check-material-updates, gradle-dependency-updates]
    if: always()
    permissions: {}
    
    steps:
      - name: Create summary
        run: |
          echo "## 📋 Dependency Update Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow checks for updates to:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Kotlin version" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Google Play Services (Maps)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Material Components (Compose BOM, Material Icons)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📝 Recommendations:" >> $GITHUB_STEP_SUMMARY
          echo "- Review the individual job outputs for specific version information" >> $GITHUB_STEP_SUMMARY
          echo "- Consider adding the [Gradle Versions Plugin](https://github.com/ben-manes/gradle-versions-plugin) for comprehensive dependency tracking" >> $GITHUB_STEP_SUMMARY
          echo "- Set up Dependabot or Renovate for automated dependency update PRs" >> $GITHUB_STEP_SUMMARY
